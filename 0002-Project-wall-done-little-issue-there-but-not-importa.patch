From 139f9488b56e69222556fc7e1550dc9c5cf8cded Mon Sep 17 00:00:00 2001
From: tiny-rejoan <rejoanul.alam@gmail.com>
Date: Wed, 23 Sep 2015 21:09:50 +0600
Subject: [PATCH 2/2] Project wall done, little issue there but not important

---
 project/templates/project/home.html         | 62 ++++++++++++++++-------------
 project/templates/project/lists.html        |  2 +-
 project/templates/project/project_menu.html |  4 +-
 project/urls.py                             | 18 ++++-----
 project/views.py                            | 19 +++++++--
 5 files changed, 62 insertions(+), 43 deletions(-)

diff --git a/project/templates/project/home.html b/project/templates/project/home.html
index 7aeefeb..dcf4a54 100644
--- a/project/templates/project/home.html
+++ b/project/templates/project/home.html
@@ -8,9 +8,9 @@
             <p>Project Lead</p>
         </div>
         <div class="p_up_right">
-            <p>Project Creation Date : </p>
+            <p>Project Creation Date : {{project.create_date}}</p>
             <div class="clear"></div>
-            <p>Estimated Project Deadline : </p>
+            <p>Estimated Project Deadline : {{project.deadline}}</p>
             <div class="clear"></div>
         </div>
         <div class="clear"></div>
@@ -20,46 +20,52 @@
             <h1>Team Members</h1>
             <div id="lead_member">
                 <p id="lead">Lead Members</p>
-            <p>tese</p>
+                {% for lead in leaders %}
+                  <p>{{lead.username}}</p>
+                {% endfor %}
             </div>
             <div id="general_member">
                 <p id="general">General Members</p>
-              <p>test</p>
+                {% for member in members %}
+                  <p>{{member.username}}</p>
+                {% endfor %}
             </div>
         </div>
         <div class="p_middle_right">
             <h1>
                 <span>Project Stream</span>
-                <!--a href="project_home.php?ID=<?php echo $project_ID; ?>">Browse all activity</a-->
             </h1>
             <div class="clear"></div>
             <div id="project_stream">
+              {% for d in latest_three %}
                 <div class="stream_details">
-                    <p>date</p>
-                    <a href="project_ticket_details.php?ID=<?php echo $project_ID; ?>&t_ID=<?php echo $nested_item['ticket_ID']; ?>&c_ID=<?php echo $nested_item['creator_ID']; ?>">
-                        <div class="stream_data">
-                            <div class="stream_time"></div>
-                            <div class="stream_status_m">
-                                <div class="stream_status">
-                                    <span></span> - updated
-                                    <span></span>
+                      <p>{{d.create_date}}</p>
+                    {% for cm in comments %}
+                        {% if d.create_date == cm.create_date|date:'d-m-Y' %}
+                            <a href="{% url 'project:ticket_details' project_id cm.ticket_id %}">
+                                <div class="stream_data">
+                                    <div class="stream_time">{{cm.create_date|date:'h:i'}}</div>
+                                    <div class="stream_status_m">
+                                        <div class="stream_status">
+                                            <span>{{cm.username}}</span> - updated
+                                            <span>{{cm.t_title}}</span>
+                                        </div>
+                                        {% if cm.prev_status and cm.prev_status.strip %}
+                                        <div class="stream_status_change">
+                                            <span>Status</span> changed from <span>{{cm.prev_status}}</span> to <span>{{cm.curr_status}}
+                                        </div>
+                                        {% endif %}
+                                        <div class="stream_comment">
+                                            commented - <span>"{{cm.details}}"</span>
+                                        </div>
+                                    </div>
+                                    <div class="clear"></div>
                                 </div>
-
-                                <div class="stream_status_change">
-                                    <span>Status</span> changed from <span></span> to <span>
-                                </div>
-
-                                <div class="stream_comment">
-                                    commented - <span>""</span>
-                                </div>
-
-                            </div>
-                            <div class="clear"></div>
-                        </div>
-                    </a>
-
+                            </a>
+                        {% endif %}
+                    {% endfor %}
                 </div>
-
+              {% endfor %}
             </div>
         </div>
         <div class="clear"></div>
diff --git a/project/templates/project/lists.html b/project/templates/project/lists.html
index 22a3fd9..e101cf1 100644
--- a/project/templates/project/lists.html
+++ b/project/templates/project/lists.html
@@ -50,7 +50,7 @@
                             </td>
                             <td valign="center" align="center">
                               <a class="table-icon edit" title="Edit Project" href="{% url 'project:project_edit' project.project_id  %}"></a>
-                              <a class="table-icon details" title="Project Details" href=""></a>
+                              <a class="table-icon details" title="Project Details" href="{% url 'project:project_wall' project.project_id %}"></a>
                             </td>
                         </tr>
                         {% endfor %}
diff --git a/project/templates/project/project_menu.html b/project/templates/project/project_menu.html
index c05dc84..765a4de 100644
--- a/project/templates/project/project_menu.html
+++ b/project/templates/project/project_menu.html
@@ -2,7 +2,7 @@
     <li><a href="{% url "project:projects" %}">Project Home</a></li>
     <li><a href="{% url "project:ticket_create" project_id %}">New Ticket</a></li>
     <li><a href="{% url "project:tickets" project_id %}">Tickets</a></li>
-    <li><a href="#">Project Wall</a></li>
-    <li><a href="">Milestones</a></li>
+    <li><a href="{% url "project:project_wall" project_id %}">Project Wall</a></li>
+    <li><a href="{% url "project:milestone_all" project_id %}">Milestones</a></li>
     <li><a href="#">Files</a></li>
 </ul>
diff --git a/project/urls.py b/project/urls.py
index 696ddbf..6d978df 100644
--- a/project/urls.py
+++ b/project/urls.py
@@ -2,18 +2,18 @@ from django.conf.urls import url
 from . import views
 
 urlpatterns = [
-
-    url(r'^create/$', views.project_create,name="project_create"),
-    url(r'^(?P<project_id>[0-9]+)/edit/', views.project_edit, name="project_edit"),
-    url(r'^(?P<project_id>[0-9]+)/ticket/create/', views.ticket_create, name="ticket_create"),
-    url(r'^(?P<project_id>[0-9]+)/ticket/(?P<ticket_id>[0-9]+)/details/', views.ticket_details, name="ticket_details"),
-    url(r'^(?P<project_id>[0-9]+)/ticket/(?P<ticket_id>[0-9]+)/edit/', views.ticket_edit, name="ticket_edit"),
-    url(r'^(?P<project_id>[0-9]+)/ticket/(?P<ticket_id>[0-9]+)/delete/', views.ticket_delete, name="ticket_delete"),
-    url(r'^(?P<project_id>[0-9]+)/tickets/', views.tickets, name="tickets"),
+    url(r'^create/$', views.project_create,name='project_create'),
+    url(r'^(?P<project_id>[0-9]+)/edit', views.project_edit, name='project_edit'),
+    url(r'^(?P<project_id>[0-9]+)/ticket/create', views.ticket_create, name='ticket_create'),
+    url(r'^(?P<project_id>[0-9]+)/ticket/(?P<ticket_id>[0-9]+)/details', views.ticket_details, name='ticket_details'),
+    url(r'^(?P<project_id>[0-9]+)/ticket/(?P<ticket_id>[0-9]+)/edit', views.ticket_edit, name='ticket_edit'),
+    url(r'^(?P<project_id>[0-9]+)/ticket/(?P<ticket_id>[0-9]+)/delete', views.ticket_delete, name='ticket_delete'),
+    url(r'^(?P<project_id>[0-9]+)/tickets', views.tickets, name='tickets'),
     url(r'^(?P<project_id>[0-9]+)/milestone/create', views.milestone_create, name='milestone_create'),
     url(r'^(?P<project_id>[0-9]+)/milestone/(?P<milestone_id>[0-9]+)/edit', views.milestone_edit, name='milestone_edit'),
     url(r'^(?P<project_id>[0-9]+)/milestone/(?P<milestone_id>[0-9]+)/delete', views.milestone_delete, name='milestone_delete'),
     url(r'^(?P<project_id>[0-9]+)/milestone', views.milestone_all, name='milestone_all'),
-    url(r'^$', views.projects, name="projects"),
+    url(r'^(?P<project_id>[0-9]+)/', views.project_wall, name='project_wall'),
+    url(r'^$', views.projects, name='projects'),
 
 ]
diff --git a/project/views.py b/project/views.py
index d5ad7c8..bbd7242 100644
--- a/project/views.py
+++ b/project/views.py
@@ -1,7 +1,6 @@
-from django.shortcuts import render_to_response, redirect, get_object_or_404
+from django.shortcuts import render_to_response, redirect, get_object_or_404,render
 from django.template import RequestContext
 from django.http import HttpResponse,HttpResponseRedirect
-from django.shortcuts import render,get_object_or_404
 from .models import Project, ProjectFile, ProjectMember, MilestoneType, Milestone, Ticket, TicketFile, Comment
 from django.utils import timezone
 import time
@@ -9,7 +8,7 @@ from django.utils.dateformat import DateFormat
 from django.conf import settings
 from authentication.models import Account
 from .forms import ProjectForm, MilestoneForm, MilestoneEditForm,ProjectEditForm,TicketForm,TicketEditForm
-from django.db.models import Q,F
+from django.db.models import Q,F,Count
 from django.contrib.auth.decorators import login_required
 import os
 
@@ -317,6 +316,20 @@ def ticket_details(request,project_id,ticket_id):
     return render(request, 'ticket/details.html', {'tickets':tickets,'ticket_files':ticket_files,'project_id':project_id,'comments':comments})
 
 
+
+
+@login_required
+def project_wall(request,project_id):
+    project = get_object_or_404(Project, pk=project_id)
+    leaders = ProjectMember.objects.filter(project_id=project_id,member_type=1).select_related('user').annotate(username=F('user__username'))
+    members = ProjectMember.objects.filter(project_id=project_id,member_type=2).select_related('user').annotate(username=F('user__username'))
+
+    latest_three = Comment.objects.extra(select={'create_date':"to_char(create_date,'DD-MM-YYYY')"}).values('create_date').annotate(dcount=Count('create_date')).order_by('-create_date')
+    #import pdb;pdb.set_trace()
+    comments = Comment.objects.filter(ticket__project_id=project_id).select_related('creator','ticket').annotate(username=F('creator__username'),t_title=F('ticket__title')).values()
+    return render(request, 'project/home.html', {'project':project,'project_id':project_id,'comments':comments,'leaders':leaders,'members':members,'latest_three':latest_three})
+
+
 @login_required
 def ticket_delete(request, project_id, ticket_id):
     ticket = get_object_or_404(Ticket, pk=ticket_id)
-- 
1.9.5.msysgit.0

